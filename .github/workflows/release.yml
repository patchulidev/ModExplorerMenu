name: Release on PR merge

on:
  push:
    branches: [ main ]

permissions:
  contents: write   # required to create tags/releases with GITHUB_TOKEN

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # we need tags to compute next version
          fetch-tags: true

      # You said /dist is committed and already contains the distributable.

      - name: Zip dist (with versioned name)
        id: zip
        run: |
          set -euo pipefail
          test -d dist

          # We'll create the zip later once we know the version.
          echo "ready=true" >> "$GITHUB_OUTPUT"

      # Determine PR number (best-effort): looks for "#123" in the merge commit message
      - name: Determine PR number (best-effort)
        id: pr
        run: |
          set -euo pipefail
          msg="$(git log -1 --pretty=%B)"
          if [[ "$msg" =~ \#([0-9]+) ]]; then
            echo "number=${BASH_REMATCH[1]}" >> "$GITHUB_OUTPUT"
          else
            echo "number=" >> "$GITHUB_OUTPUT"
          fi

      - name: Determine bump from PR labels (default: patch)
        id: bump
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          bump="patch"

          if [[ -n "${PR_NUMBER}" ]]; then
            labels="$(gh api repos/$REPO/pulls/$PR_NUMBER --jq '.labels[].name' || true)"
            echo "PR labels:"
            echo "$labels" || true

            if echo "$labels" | grep -q '^release:major$'; then bump="major"; fi
            if echo "$labels" | grep -q '^release:minor$'; then bump="minor"; fi
            if echo "$labels" | grep -q '^release:patch$'; then bump="patch"; fi
            if echo "$labels" | grep -q '^release:skip$';  then bump="skip";  fi
          fi

          echo "bump=$bump" >> "$GITHUB_OUTPUT"

      - name: Compute next semver tag
        id: version
        if: steps.bump.outputs.bump != 'skip'
        run: |
          set -euo pipefail

          # Get latest vX.Y.Z tag (fallback to v0.0.0)
          latest="$(git tag -l 'v*' | sort -V | tail -n 1 || true)"
          if [[ -z "$latest" ]]; then latest="v0.0.0"; fi
          echo "Latest tag: $latest"

          ver="${latest#v}"
          IFS='.' read -r major minor patch <<< "$ver"

          bump="${{ steps.bump.outputs.bump }}"
          case "$bump" in
            major) major=$((major+1)); minor=0; patch=0 ;;
            minor) minor=$((minor+1)); patch=0 ;;
            patch) patch=$((patch+1)) ;;
          esac

          next="v${major}.${minor}.${patch}"
          echo "next=$next" >> "$GITHUB_OUTPUT"
          echo "Next tag: $next"

      - name: Create dist zip with release name
        if: steps.bump.outputs.bump != 'skip'
        id: distzip
        run: |
          set -euo pipefail
          version="${{ steps.version.outputs.next }}"

          # Asset filename you requested
          asset_name="Modex - A Mod Explorer Menu - ${version}.zip"
          echo "asset_name=$asset_name" >> "$GITHUB_OUTPUT"

          # Create zip at repo root
          (cd dist && zip -r "../${asset_name}" .)

      - name: Create GitHub Release and upload dist zip
        if: steps.bump.outputs.bump != 'skip'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.next }}
          name: Modex - A Mod Explorer Menu - ${{ steps.version.outputs.next }}
          generate_release_notes: true
          files: |
            ${{ steps.distzip.outputs.asset_name }}
